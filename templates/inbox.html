{% extends 'base.html' %} {% block content %}

<script>
    async function fetchInbox() {
        const response = await fetch('/fetch-emails');
        const data = await response.json();
        const { email_address, messages } = data;

        // Store the email address in local/session storage
        sessionStorage.setItem('email_address', email_address);

        messages.forEach((message) => {
            if (!message.isRead) {
                const htmlString = message.body.content;

                function extractEmailContent(html) {
                    const parser = new DOMParser();
                    const parsedHtml = parser.parseFromString(
                        html,
                        'text/html'
                    );

                    // You can adjust the query selector to fit your specific needs
                    const body = parsedHtml.querySelector('body');
                    const lines = [];

                    function traverseNodes(node) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            const text = node.textContent.trim();
                            if (text) {
                                lines.push(text);
                            }
                        } else if (node.childNodes.length) {
                            node.childNodes.forEach(traverseNodes);
                        }
                    }

                    traverseNodes(body);
                    return lines.join('\n');
                }

                const sectionEmails = document.querySelector('.section-emails');
                const container = document.querySelector('.container');
                const emailCard = document.createElement('figure');
                const emailHeader = document.createElement('header');
                const emailAddress = document.createElement('p');
                const fullName = document.createElement('p');
                const emailSubject = document.createElement('p');
                const emailContentContainer = document.createElement('div');
                const emailContent = document.createElement('p');

                emailContent.textContent = extractEmailContent(htmlString);

                emailCard.classList.add('email-card');
                emailHeader.classList.add('email-header');
                emailAddress.classList.add('email-address');
                fullName.classList.add('full-name');
                emailSubject.classList.add('email-subject');
                emailContentContainer.classList.add(
                    'hidden',
                    'email-content-container'
                );
                emailContent.classList.add('email-content');

                emailAddress.textContent = message.from.emailAddress.address;
                fullName.textContent = message.from.emailAddress.name;
                emailSubject.textContent = message.subject;

                emailHeader.appendChild(fullName);
                emailHeader.appendChild(emailAddress);
                emailHeader.appendChild(emailSubject);

                emailCard.appendChild(emailHeader);
                emailContentContainer.appendChild(emailContent);
                emailCard.appendChild(emailContentContainer);
                sectionEmails.appendChild(emailCard);

                emailCard.addEventListener('click', () => {
                    emailContentContainer.classList.toggle('hidden');
                });
            }
        });
    }

    function switchView() {
        const btnTag = document.getElementById('btn-tag');
        const btnInbox = document.getElementById('btn-inbox');
        const sectionEmails = document.querySelector('.section-emails');
        const sectionTags = document.querySelector('.section-tags');

        btnTag.addEventListener('click', () => {
            btnInbox.classList.toggle('selected');
            btnTag.classList.toggle('selected');
            sectionEmails.style.display = 'none';
            sectionTags.style.display = 'block';
        });

        btnInbox.addEventListener('click', () => {
            btnInbox.classList.toggle('selected');
            btnTag.classList.toggle('selected');
            sectionTags.style.display = 'none';
            sectionEmails.style.display = 'block';
        });
    }

    window.onload = () => {
        fetchInbox();
        switchView();
    };
</script>

<!-- MAIN -->
<main>
    <div class="container inbox-container">
        <aside class="side-navigation">
            <button id="btn-inbox" class="btn-side-nav selected">Inbox</button>
            <button id="btn-tag" class="btn-side-nav">Tags</button>
        </aside>

        <!-- EMAILS SECTION -->
        <section class="section-emails"></section>

        <!-- TAGS SECTION -->
        <section class="section-tags"></section>
    </div>
</main>
{% endblock content %}
