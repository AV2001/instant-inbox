{% extends 'base.html' %} {% block content %}

<script>
    async function fetchInbox() {
        const response = await fetch('/fetch-emails');
        const data = await response.json();
        const { email_address, messages } = data;

        saveUserData(email_address);

        // Store the email address in local/session storage
        sessionStorage.setItem('email_address', email_address);

        messages.forEach((message) => {
            if (!message.isRead) {
                const sectionEmails = document.querySelector('.section-emails');
                const container = document.querySelector('.container');
                const emailCard = document.createElement('figure');
                const emailHeader = document.createElement('header');
                const emailAddress = document.createElement('p');
                const fullName = document.createElement('p');
                const emailSubject = document.createElement('p');
                const emailContentContainer = document.createElement('div');
                const emailContent = document.createElement('p');

                emailContent.textContent = message.body.content;

                emailCard.classList.add('email-card');
                emailHeader.classList.add('email-header');
                emailAddress.classList.add('email-address');
                fullName.classList.add('full-name');
                emailSubject.classList.add('email-subject');
                emailContentContainer.classList.add(
                    'hidden',
                    'email-content-container'
                );
                emailContent.classList.add('email-content');

                emailAddress.textContent = message.from.emailAddress.address;
                fullName.textContent = message.from.emailAddress.name;
                emailSubject.textContent = message.subject;

                emailHeader.appendChild(fullName);
                emailHeader.appendChild(emailAddress);
                emailHeader.appendChild(emailSubject);

                emailCard.appendChild(emailHeader);
                emailContentContainer.appendChild(emailContent);
                emailCard.appendChild(emailContentContainer);
                sectionEmails.appendChild(emailCard);

                emailCard.addEventListener('click', () => {
                    emailContentContainer.classList.toggle('hidden');
                });
            }
        });
    }

    function switchView() {
        const btnTag = document.getElementById('btn-tag');
        const btnInbox = document.getElementById('btn-inbox');
        const sectionEmails = document.querySelector('.section-emails');
        const sectionTags = document.querySelector('.section-tags');

        sectionTags.style.display = 'none';

        btnTag.addEventListener('click', () => {
            btnInbox.classList.toggle('selected');
            btnTag.classList.toggle('selected');
            sectionEmails.style.display = 'none';
            sectionTags.style.display = 'flex';
        });

        btnInbox.addEventListener('click', () => {
            btnInbox.classList.toggle('selected');
            btnTag.classList.toggle('selected');
            sectionTags.style.display = 'none';
            sectionEmails.style.display = 'block';
        });
    }

    async function saveUserData(email_address) {
        const response = await fetch('/save-user-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email_address }),
        });

        const data = await response.json();

        // Update the textarea elements with the fetched tag
        document.getElementById('module-change').value = data.module_change;
        document.getElementById('travel-leave').value = data.travel_leave;
        document.getElementById('sick-leave').value = data.sick_leave;
    }

    async function saveTags() {
        const emailAddress = sessionStorage.getItem('email_address');
        const moduleChange = document.getElementById('module-change').value;
        const travelLeave = document.getElementById('travel-leave').value;
        const sickLeave = document.getElementById('sick-leave').value;

        const response = await fetch('/update-tags', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email_address: emailAddress,
                module_change: moduleChange,
                travel_leave: travelLeave,
                sick_leave: sickLeave,
            }),
        });

        if (response.status === 200) {
            swal({
                title: 'Tags updated!',
                text: 'Tags updated successfully!',
                icon: 'success',
            });
        } else if (response.status === 304) {
            swal({
                title: 'Content unchanged!',
                text: 'You have NOT changed the content of any tag.',
                icon: 'warning',
            });
        } else {
            // Handle other unexpected status codes
            swal({
                title: 'Error!',
                text: 'An unexpected error occurred. Please try again.',
                icon: 'error',
            });
        }
    }

    window.onload = () => {
        fetchInbox();
        switchView();

        // To register the event listener for the "Save" button
        document.getElementById('btn-save').addEventListener('click', saveTags);
    };
</script>

<!-- MAIN -->
<main>
    <div class="container inbox-container">
        <aside class="side-navigation">
            <button id="btn-inbox" class="btn-side-nav selected">Inbox</button>
            <button id="btn-tag" class="btn-side-nav">Tags</button>
        </aside>

        <!-- EMAILS SECTION -->
        <section class="section-emails"></section>

        <!-- TAGS SECTION -->
        <section class="section-tags">
            <figure class="tag tag--module-change">
                <div class="tag-heading-box">
                    <p class="tag-heading">Module Change</p>
                </div>
                <div class="tag-content-box">
                    <textarea
                        name="module-change"
                        id="module-change"
                        rows="3"
                    ></textarea>
                </div>
            </figure>
            <figure class="tag tag--travel-leave">
                <div class="tag-heading-box">
                    <p class="tag-heading">Travel Leave</p>
                </div>
                <div class="tag-content-box">
                    <textarea
                        name="travel-leave"
                        id="travel-leave"
                        rows="3"
                    ></textarea>
                </div>
            </figure>
            <figure class="tag tag--sick-leave">
                <div class="tag-heading-box">
                    <p class="tag-heading">Sick Leave</p>
                </div>
                <div class="tag-content-box">
                    <textarea
                        name="sick-leave"
                        id="sick-leave"
                        rows="3"
                    ></textarea>
                </div>
            </figure>

            <button id="btn-save" class="btn btn--filled">Save</button>
        </section>
    </div>
</main>
{% endblock content %}
